<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NICU Dose Calculator | Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹</title>
    <meta name="description" content="Professional dose calculator for Neonatal Intensive Care Units with Arabic RTL support">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        teal: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        amber: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            min-height: 100vh;
        }
        .screen-transition {
            transition: all 0.5s ease-in-out;
        }
        .screen-hidden {
            opacity: 0;
            transform: translateY(-1rem);
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        .screen-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .drug-button {
            transition: all 0.3s;
        }
        .drug-button:hover {
            transform: translateY(-0.25rem);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-teal-50 min-h-screen flex flex-col">
    
    <!-- Header Section -->
    <header class="bg-gradient-to-l from-sky-500 to-teal-500 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <button id="backBtn" onclick="handleBack()" class="text-white hover:bg-white/20 p-2 rounded-full hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                    </button>
                </div>
                <div class="text-center flex-1">
                    <h1 class="text-3xl md:text-4xl font-bold">
                        Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹
                    </h1>
                    <p class="text-sky-100 text-sm md:text-base">
                        Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø±Ø¹Ø§ÙŠØ© Ø­Ø¯ÙŠØ«ÙŠ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©
                    </p>
                </div>
                <div class="flex-1 flex justify-end">
                    <div id="headerPatientInfo" class="bg-white/20 rounded-lg px-3 py-2 flex items-center gap-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0 0-4-4H8a4 4 0 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <div class="text-sm">
                            <div id="headerPatientName" class="font-semibold">Ù…Ø¬Ù‡ÙˆÙ„</div>
                            <div id="headerPatientWeight" class="text-sky-100">0 ÙƒØ¬Ù…</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-8 relative">
        
        <!-- Greeting Screen -->
        <div id="greetingScreen" class="screen-transition screen-visible">
            <div class="flex items-center justify-center h-full">
                <div class="w-full max-w-md">
                    <div class="shadow-2xl border-sky-200 rounded-xl bg-white">
                        <div class="bg-gradient-to-l from-sky-50 to-teal-50 border-b border-sky-200 p-6 rounded-t-xl">
                            <h2 class="text-2xl text-sky-800 text-center font-bold">
                                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                            </h2>
                            <p class="text-center text-sky-700">
                                Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
                            </p>
                        </div>
                        <div class="p-6 space-y-6">
                            <!-- Baby Name Input -->
                            <div class="space-y-2">
                                <label for="babyName" class="text-sky-800 text-base font-semibold block">
                                    Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„
                                </label>
                                <input
                                    id="babyName"
                                    type="text"
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„"
                                    class="w-full text-lg border-sky-300 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-500 text-right"
                                    dir="rtl"
                                />
                            </div>

                            <!-- Baby Weight Input -->
                            <div class="space-y-2">
                                <label for="babyWeight" class="text-sky-800 text-base font-semibold block">
                                    ÙˆØ²Ù† Ø§Ù„Ø·ÙÙ„ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…
                                </label>
                                <input
                                    id="babyWeight"
                                    type="text"
                                    step="0.01"
                                    min="0"
                                    placeholder="Ù…Ø«Ø§Ù„: 1.25 Ø£Ùˆ Ù¢.Ù¥"
                                    class="w-full text-lg border-sky-300 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-500 text-right"
                                    dir="rtl"
                                />
                                <p class="text-sm text-sky-600 mt-2">
                                    ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù… (ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
                                </p>
                            </div>

                            <!-- Error Message -->
                            <div id="errorMessage" class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg text-center hidden">
                            </div>

                            <!-- Action Button -->
                            <button
                                onclick="handleSelectTreatment()"
                                class="w-full bg-gradient-to-l from-sky-500 to-teal-500 hover:from-sky-600 hover:to-teal-600 text-white text-lg font-bold py-4 shadow-lg rounded-lg transition-all duration-200 hover:shadow-xl"
                            >
                                Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù„Ø§Ø¬
                            </button>

                            <!-- Info Note -->
                            <div class="bg-sky-50 border border-sky-200 rounded-lg p-4">
                                <p class="text-sm text-sky-700 text-center">
                                    ğŸ’¡ ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drug Selection Screen -->
        <div id="drugSelectionScreen" class="screen-transition screen-hidden">
            <div class="container mx-auto max-w-4xl">
                <!-- Patient Info Card -->
                <div class="mb-6 bg-gradient-to-l from-sky-100 to-teal-100 border-sky-300 rounded-xl">
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="bg-gradient-to-l from-sky-500 to-teal-500 rounded-full p-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0 0-4-4H8a4 4 0 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 id="selectionPatientName" class="text-xl font-bold text-sky-800 mb-1">
                                        Ù…Ø¬Ù‡ÙˆÙ„
                                    </h2>
                                    <p class="text-sky-700">
                                        Ø§Ù„ÙˆØ²Ù†: <span id="selectionPatientWeight" class="font-bold">0</span> ÙƒØ¬Ù…
                                    </p>
                                </div>
                            </div>
                            <div class="bg-white/50 rounded-full px-3 py-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22 12 18 12 15 6 12"/>
                                    <polyline points="22 12 18 12 15 6 12"/>
                                    <circle cx="22" cy="12" r="2"/>
                                    <circle cx="6" cy="12" r="3"/>
                                </svg>
                                <span id="selectedDrugsCount" class="text-sm text-sky-700">
                                    0 Ø¯ÙˆØ§Ø¡ Ù…Ø­Ø¯Ø¯
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Title -->
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-sky-800 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h2>
                    <p class="text-sky-700">
                        Ø­Ø¯Ø¯ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
                    </p>
                </div>

                <!-- Drug Grid -->
                <div id="drugGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-24">
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen-transition screen-hidden">
            <div class="container mx-auto max-w-5xl">
                <!-- Summary Card -->
                <div class="mb-6 bg-gradient-to-l from-emerald-500 to-teal-600 border-emerald-600 rounded-xl">
                    <div class="p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="bg-white/20 rounded-full p-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                                        <line x1="12" y1="6" x2="12" y2="10"/>
                                        <line x1="8" y1="16" x2="8" y2="16"/>
                                        <line x1="16" y1="16" x2="16" y2="16"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold mb-1">
                                        Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨
                                    </h2>
                                    <p class="text-emerald-100">
                                        <span id="resultsPatientName"></span> - <span id="resultsPatientWeight"></span> ÙƒØ¬Ù… - <span id="resultsDrugsCount"></span> Ø¯ÙˆØ§Ø¡
                                    </p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 w-full max-w-xs">
                                <button
                                    onclick="handleStartOver()"
                                    class="w-full bg-white/20 border border-white text-white font-bold hover:bg-white/30 hover:text-white px-4 py-3 rounded-lg transition-all duration-200"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2">
                                        <path d="M14 2H6a2 2 0 0 0 0-2 2v16a2 2 0 0 0 0 2 2h12a2 2 0 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 8 8 8 8 8 8 8 8 8 14 8 14 2"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10 9 9 9 8 9"/>
                                    </svg>
                                    Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯
                                </button>
                                <a
                                    href="https://t.me/NICU_BTHbot"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="inline-flex items-center justify-center gap-2 w-full px-4 py-3 bg-white/20 border border-white text-white font-bold hover:bg-white/30 hover:text-white rounded-lg shadow transition-all duration-200 hover:shadow-lg"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2">
                                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.38 8.38 0 0 1-3.8-.9l-9-9a8.38 8.38 0 0 1-1.3 7.1 8.38 8.38 0 0 1 7.1 1.3l9 9a8.38 8.38 0 0 1 .9 3.8 8.38 8.38 0 0 1 3.8.9"/>
                                    </svg>
                                    Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ø¯Ù„Ø©
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Grid -->
                <div id="resultsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-24">
                </div>

                <!-- Mandatory Safety Disclaimer -->
                <div class="mt-6 mb-8 bg-amber-50 border-2 border-amber-300 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#92400e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 0-1.71 1.71l12 2-12-2a2 2 0 0 0 0 1.71-1.71l-8.48 8.48"/>
                            <path d="M15 18h6"/>
                        </svg>
                        <div>
                            <p class="text-amber-900 font-bold text-lg italic mb-1">
                                Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ§ÙƒØ¯ Ø¬ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¬Ø±Ø¹ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø§Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ø¬
                            </p>
                            <p class="text-amber-700 text-sm">
                                âš ï¸ Ø§Ø­Ø±Øµ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¯ÙˆØ§Ø¡
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Fixed Calculate Button -->
    <div id="calculateBtnContainer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-sky-200 p-4 shadow-lg hidden">
        <div class="container mx-auto max-w-4xl">
            <button
                id="calculateBtn"
                onclick="handleCalculateDoses()"
                class="w-full py-4 text-lg font-bold shadow-lg transition-all duration-300 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-l from-sky-500 to-teal-500 text-white rounded-lg"
            >
                Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹
                <span id="selectedCountBadge" class="mr-2 bg-white/20 px-3 py-1 rounded-full hidden"></span>
            </button>
        </div>
    </div>

    <!-- Footer -->
    <div id="greetingFooter" class="bg-white border-t border-sky-200 py-4 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sky-700 text-sm">
                Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø±Ø¹Ø§ÙŠØ© Ø­Ø¯ÙŠØ«ÙŠ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© - NICU Dose Calculator
            </p>
            <p class="text-sky-500 text-xs mt-1">
                ØªÙ… ØªØµÙ…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· - ÙŠØ±Ø¬Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
            </p>
        </div>
    </div>

    <script>
        // Drug Data
        const DRUGS = [
            { id: 1, name: 'Amoxicillin', nameAr: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ†', dosePerKg: 50, unit: 'mg', factor: 1, methodIndex: 1, timeMultiplier: 1 },
            { id: 2, name: 'Gentamicin', nameAr: 'Ø¬Ù†ØªØ§Ù…ÙŠØ³ÙŠÙ†', dosePerKg: 5, unit: 'mg', factor: 12.5, methodIndex: 2, timeMultiplier: 1 },
            { id: 3, name: 'Caffeine Loading', nameAr: 'ÙƒØ§ÙÙŠÙŠÙ† ØªØ­Ù…ÙŠÙ„ÙŠ', dosePerKg: 20, unit: 'mg', factor: 2, methodIndex: 3, timeMultiplier: 1 },
            { id: 4, name: 'Caffeine Maintenance', nameAr: 'ÙƒØ§ÙÙŠÙŠÙ† ØµÙŠØ§Ù†Ø©', dosePerKg: 10, unit: 'mg', factor: 50, methodIndex: 4, timeMultiplier: 1 },
            { id: 5, name: 'Colistin Loading', nameAr: 'ÙƒÙˆÙ„ÙŠØ³ØªÙŠÙ† ØªØ­Ù…ÙŠÙ„ÙŠ', dosePerKg: 150, unit: 'IU', factor: 30, methodIndex: 5, timeMultiplier: 1 },
            { id: 6, name: 'Colistin Maintenance', nameAr: 'ÙƒÙˆÙ„ÙŠØ³ØªÙŠÙ† ØµÙŠØ§Ù†Ø©', dosePerKg: 37.5, unit: 'IU', factor: 7.5, methodIndex: 6, timeMultiplier: 1 },
            { id: 7, name: 'Tigecycline', nameAr: 'ØªÙŠØ¬ÙŠØ³Ø§ÙŠÙƒÙ„ÙŠÙ†', dosePerKg: 2, unit: 'mg', factor: 2, methodIndex: 7, timeMultiplier: 1 },
            { id: 8, name: 'Meropenem', nameAr: 'Ù…ÙŠØ±ÙˆØ¨ÙŠÙ†ÙŠÙ…', dosePerKg: 40, unit: 'mg', factor: 1.6, methodIndex: 8, timeMultiplier: 1 },
            { id: 9, name: 'Dopamine', nameAr: 'Ø¯ÙˆØ¨Ø§Ù…ÙŠÙ†', dosePerKg: 5, unit: 'mcg', factor: 36, methodIndex: 9, timeMultiplier: 1440 },
            { id: 10, name: 'Dexmedetomidine', nameAr: 'Ø¯ÙŠÙƒØ³Ù…ÙŠØ¯ØªÙˆÙ…ÙŠØ¯ÙŠÙ†', dosePerKg: 0.3, unit: 'mcg', factor: 14.4, methodIndex: 10, timeMultiplier: 24 }
        ];

        // Administration Methods
        const ADMINISTRATION_METHODS = {
            1: 'ØªØ³Ø­Ø¨ ** Ù…Ù„ ÙˆØªØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
            2: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚',
            3: 'ØªØ³Ø­Ø¨ ** Ù…Ù„ ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
            4: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚',
            5: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
            6: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
            7: 'ØªØ³Ø­Ø¨ ** ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
            8: 'ØªØ³Ø­Ø¨ ** ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
            9: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ 20 Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
            10: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ 20 Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ'
        };

        // State
        let currentScreen = 'greeting';
        let selectedDrugs = [];
        let patientInfo = null;
        let calculationResults = [];

        // Functions
        const normalizeArabicNumerals = (value) => {
            const trimmedValue = value.trim();
            const arabicToEnglishMap = {
                'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
                'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
            };
            return trimmedValue.replace(/[Ù -Ù©]/g, (match) => arabicToEnglishMap[match] || match);
        };

        const formatNumber = (value, decimals = 1) => {
            const isWholeNumber = value === Math.round(value);
            return isWholeNumber ? value.toFixed(0) : value.toFixed(decimals);
        };

        const formatDrugRule = (drug) => {
            if (drug.unit === 'IU' && (drug.id === 5 || drug.id === 6)) {
                const roundedDose = Math.round(drug.dosePerKg);
                return `${roundedDose.toLocaleString('en-US')},000 IU/kg/dose`;
            }
            return `${drug.dosePerKg} ${drug.unit}/kg${drug.timeMultiplier > 1 ? `/${drug.timeMultiplier === 1440 ? 'min' : 'hr'}` : ''}/dose`;
        };

        const showScreen = (screenName) => {
            ['greetingScreen', 'drugSelectionScreen', 'resultsScreen'].forEach(screen => {
                const element = document.getElementById(screen);
                if (screenName === screen) {
                    element.classList.remove('screen-hidden');
                    element.classList.add('screen-visible');
                } else {
                    element.classList.remove('screen-visible');
                    element.classList.add('screen-hidden');
                }
            });
            
            // Update header and footer visibility
            document.getElementById('backBtn').classList.toggle('hidden', currentScreen === 'greeting');
            document.getElementById('headerPatientInfo').classList.toggle('hidden', currentScreen === 'greeting' || !patientInfo);
            document.getElementById('greetingFooter').classList.toggle('hidden', currentScreen !== 'greeting');
            document.getElementById('calculateBtnContainer').classList.toggle('hidden', currentScreen !== 'drugSelection');
        };

        const handleSelectTreatment = () => {
            const babyName = document.getElementById('babyName').value.trim();
            const babyWeight = normalizeArabicNumerals(document.getElementById('babyWeight').value);
            const errorEl = document.getElementById('errorMessage');

            if (!babyWeight || babyWeight.trim() === '') {
                errorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† Ø§Ù„Ø·ÙÙ„';
                errorEl.classList.remove('hidden');
                return;
            }

            const weightAsNumber = parseFloat(babyWeight);
            if (isNaN(weightAsNumber) || weightAsNumber <= 0) {
                errorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ØµØ­ÙŠØ­';
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');
            patientInfo = { name: babyName, weight: weightAsNumber };
            
            console.log('NICU Dose Calculator - Patient Info:', { babyName, babyWeight: weightAsNumber });
            
            currentScreen = 'drugSelection';
            updateDrugSelectionUI();
            showScreen('drugSelection');
        };

        const handleDrugToggle = (drugId) => {
            if (selectedDrugs.includes(drugId)) {
                selectedDrugs = selectedDrugs.filter(id => id !== drugId);
            } else {
                selectedDrugs.push(drugId);
            }
            updateDrugSelectionUI();
        };

        const updateDrugSelectionUI = () => {
            document.getElementById('selectionPatientName').textContent = patientInfo?.name || 'Ù…Ø¬Ù‡ÙˆÙ„';
            document.getElementById('selectionPatientWeight').textContent = patientInfo?.weight || '0';
            document.getElementById('selectedDrugsCount').textContent = `${selectedDrugs.length} Ø¯ÙˆØ§Ø¡ Ù…Ø­Ø¯Ø¯`;
            
            const calculateBtn = document.getElementById('calculateBtn');
            const badge = document.getElementById('selectedCountBadge');
            
            if (selectedDrugs.length === 0) {
                calculateBtn.disabled = true;
                badge.classList.add('hidden');
            } else {
                calculateBtn.disabled = false;
                badge.textContent = selectedDrugs.length;
                badge.classList.remove('hidden');
            }
            
            renderDrugGrid();
        };

        const renderDrugGrid = () => {
            const grid = document.getElementById('drugGrid');
            grid.innerHTML = DRUGS.map(drug => {
                const isSelected = selectedDrugs.includes(drug.id);
                return `
                    <button onclick="handleDrugToggle(${drug.id})" class="drug-button relative p-6 rounded-xl border-2 cursor-pointer ${isSelected ? 'bg-gradient-to-l from-sky-500 to-blue-600 border-blue-600 text-white shadow-xl' : 'bg-white border-sky-200 hover:border-sky-400 text-sky-800'}">
                        ${isSelected ? `
                            <div class="absolute top-3 left-3 bg-white/20 rounded-full p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 17"/>
                                </svg>
                            </div>
                        ` : ''}
                        <div class="text-left" dir="ltr">
                            <h3 class="text-xl font-bold mb-2">${drug.name}</h3>
                            <p class="text-sm font-semibold ${isSelected ? 'text-white/90' : 'text-sky-600'}">${formatDrugRule(drug)}</p>
                        </div>
                    </button>
                `;
            }).join('');
        };

        const handleCalculateDoses = () => {
            if (selectedDrugs.length === 0 || !patientInfo) return;

            calculationResults = [];
            selectedDrugs.forEach(drugId => {
                const drug = DRUGS.find(d => d.id === drugId);
                if (!drug) return;

                let totalDose = patientInfo.weight * drug.dosePerKg * drug.timeMultiplier;
                let displayDose = totalDose;
                let displayUnit = drug.unit;

                if (drug.unit === 'IU') {
                    displayDose = Math.round(totalDose * 1000) + ',000';
                    displayUnit = 'IU';
                } else if (drug.unit === 'mcg' && totalDose > 1000) {
                    displayDose = totalDose / 1000;
                    displayUnit = 'mg';
                }

                const volumeToDraw = Math.round((patientInfo.weight * drug.factor) * 10) / 10;
                const methodTemplate = ADMINISTRATION_METHODS[drug.methodIndex];
                const hasDilution = methodTemplate.includes('##');
                const dilutionVolume = hasDilution ? 20 - volumeToDraw : null;
                
                let method = methodTemplate.replace(/\*\*/g, formatNumber(volumeToDraw, 1));
                if (hasDilution && dilutionVolume !== null) {
                    method = method.replace(/##/g, formatNumber(dilutionVolume, 1));
                }

                calculationResults.push({ drug, totalDose, displayDose, displayUnit, volumeToDraw, dilutionVolume, method });
            });

            currentScreen = 'results';
            updateResultsUI();
            showScreen('results');
        };

        const updateResultsUI = () => {
            document.getElementById('resultsPatientName').textContent = patientInfo?.name || 'Ù…Ø¬Ù‡ÙˆÙ„';
            document.getElementById('resultsPatientWeight').textContent = patientInfo?.weight || '0';
            document.getElementById('resultsDrugsCount').textContent = calculationResults.length;
            renderResultsGrid();
        };

        const renderResultsGrid = () => {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = calculationResults.map((result, index) => `
                <div class="shadow-lg border-emerald-200 rounded-xl bg-white">
                    <div class="bg-gradient-to-l from-emerald-50 to-teal-50 border-b border-emerald-200 p-4">
                        <div class="flex items-center gap-3" dir="ltr">
                            <div class="bg-gradient-to-l from-emerald-500 to-teal-600 text-white text-xl font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-md">
                                ${index + 1}
                            </div>
                            <div class="flex-1 text-left">
                                <h3 class="text-3xl text-emerald-800 font-black mb-1">${result.drug.name}</h3>
                                <p class="text-emerald-700 text-base">${formatDrugRule(result.drug)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="bg-gradient-to-l from-emerald-100 to-teal-100 rounded-lg p-4">
                            <p class="text-sm text-emerald-700 mb-1">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                            <p class="text-3xl font-bold text-emerald-900">
                                ${typeof result.displayDose === 'string' ? result.displayDose : formatNumber(result.displayDose, 1)} ${result.displayUnit}
                            </p>
                        </div>
                        <div class="bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4" dir="rtl">
                            <p class="text-sm text-emerald-700 mb-2 font-semibold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¹Ø·Ø§Ø¡</p>
                            <p class="text-base text-sky-800 leading-relaxed">${result.method}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const handleBack = () => {
            if (currentScreen === 'results') {
                currentScreen = 'drugSelection';
                showScreen('drugSelection');
            } else if (currentScreen === 'drugSelection') {
                currentScreen = 'greeting';
                selectedDrugs = [];
                patientInfo = null;
                renderDrugGrid();
                updateDrugSelectionUI();
                showScreen('greeting');
            }
        };

        const handleStartOver = () => {
            currentScreen = 'greeting';
            selectedDrugs = [];
            patientInfo = null;
            calculationResults = [];
            
            document.getElementById('babyName').value = '';
            document.getElementById('babyWeight').value = '';
            document.getElementById('errorMessage').classList.add('hidden');
            
            updateDrugSelectionUI();
            renderDrugGrid();
            showScreen('greeting');
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('NICU Dose Calculator loaded');
        });
    </script>
</body>
</html>
