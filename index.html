'use client'

import { useState } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Check, ArrowLeft, Baby, Activity, Calculator, FileText, AlertTriangle, MessageCircle } from 'lucide-react'

// Complete drug data structure with all required information
const DRUGS = [
  {
    id: 1,
    name: 'Amoxicillin',
    nameAr: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ†',
    dosePerKg: 50,
    unit: 'mg',
    factor: 1,
    methodIndex: 1,
    timeMultiplier: 1
  },
  {
    id: 2,
    name: 'Gentamicin',
    nameAr: 'Ø¬Ù†ØªØ§Ù…ÙŠØ³ÙŠÙ†',
    dosePerKg: 5,
    unit: 'mg',
    factor: 12.5,
    methodIndex: 2,
    timeMultiplier: 1
  },
  {
    id: 3,
    name: 'Caffeine Loading',
    nameAr: 'ÙƒØ§ÙÙŠÙŠÙ† ØªØ­Ù…ÙŠÙ„ÙŠ',
    dosePerKg: 20,
    unit: 'mg',
    factor: 2,
    methodIndex: 3,
    timeMultiplier: 1
  },
  {
    id: 4,
    name: 'Caffeine Maintenance',
    nameAr: 'ÙƒØ§ÙÙŠÙŠÙ† ØµÙŠØ§Ù†Ø©',
    dosePerKg: 10,
    unit: 'mg',
    factor: 50,
    methodIndex: 4,
    timeMultiplier: 1
  },
  {
    id: 5,
    name: 'Colistin Loading',
    nameAr: 'ÙƒÙˆÙ„ÙŠØ³ØªÙŠÙ† ØªØ­Ù…ÙŠÙ„ÙŠ',
    dosePerKg: 150,
    unit: 'IU',
    factor: 30,
    methodIndex: 5,
    timeMultiplier: 1
  },
  {
    id: 6,
    name: 'Colistin Maintenance',
    nameAr: 'ÙƒÙˆÙ„ÙŠØ³ØªÙŠÙ† ØµÙŠØ§Ù†Ø©',
    dosePerKg: 37.5,
    unit: 'IU',
    factor: 7.5,
    methodIndex: 6,
    timeMultiplier: 1
  },
  {
    id: 7,
    name: 'Tigecycline',
    nameAr: 'ØªÙŠØ¬ÙŠØ³Ø§ÙŠÙƒÙ„ÙŠÙ†',
    dosePerKg: 2,
    unit: 'mg',
    factor: 2,
    methodIndex: 7,
    timeMultiplier: 1
  },
  {
    id: 8,
    name: 'Meropenem',
    nameAr: 'Ù…ÙŠØ±ÙˆØ¨ÙŠÙ†ÙŠÙ…',
    dosePerKg: 40,
    unit: 'mg',
    factor: 1.6,
    methodIndex: 8,
    timeMultiplier: 1
  },
  {
    id: 9,
    name: 'Dopamine',
    nameAr: 'Ø¯ÙˆØ¨Ø§Ù…ÙŠÙ†',
    dosePerKg: 5,
    unit: 'mcg',
    factor: 36,
    methodIndex: 9,
    timeMultiplier: 1440 // /min - multiply by 1440 (24 hours * 60 minutes)
  },
  {
    id: 10,
    name: 'Dexmedetomidine',
    nameAr: 'Ø¯ÙŠÙƒØ³Ù…ÙŠØ¯ØªÙˆÙ…ÙŠØ¯ÙŠÙ†',
    dosePerKg: 0.3,
    unit: 'mcg',
    factor: 14.4,
    methodIndex: 10,
    timeMultiplier: 24 // /hr - multiply by 24 (24 hours)
  }
]

// Administration methods in Arabic
const ADMINISTRATION_METHODS: Record<number, string> = {
  1: 'ØªØ³Ø­Ø¨ ** Ù…Ù„ ÙˆØªØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
  2: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚',
  3: 'ØªØ³Ø­Ø¨ ** Ù…Ù„ ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
  4: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚',
  5: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
  6: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ®ÙÙ Ø¨Ù¥ Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ± ÙˆÙŠØ¹Ø·Ù‰ Ø®Ù„Ø§Ù„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚',
  7: 'ØªØ³Ø­Ø¨ ** ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
  8: 'ØªØ³Ø­Ø¨ ** ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ ## Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
  9: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ 20 Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ',
  10: 'ØªØ³Ø­Ø¨ ** ÙˆØ­Ø¯Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØªØ¶Ø§Ù Ø§Ù„Ù‰ 20 Ø³ÙŠØ³ÙŠ ÙƒÙ„ÙˆÙƒÙˆØ² ÙˆØªØ±ØŒ ØªÙØ±Øº Ù¡Ù  Ø³ÙŠØ³ÙŠ ÙˆÙŠØ¹Ø·Ù‰ Ù¡Ù  Ø³ÙŠØ³ÙŠ'
}

// Function to convert Arabic numerals to English numerals
const normalizeArabicNumerals = (value: string): string => {
  // Trim whitespace first
  const trimmedValue = value.trim()

  // Map for Arabic numerals
  const arabicToEnglishMap: Record<string, string> = {
    'Ù ': '0',
    'Ù¡': '1',
    'Ù¢': '2',
    'Ù£': '3',
    'Ù¤': '4',
    'Ù¥': '5',
    'Ù¦': '6',
    'Ù§': '7',
    'Ù¨': '8',
    'Ù©': '9'
  }

  return trimmedValue.replace(/[Ù -Ù©]/g, (match) => arabicToEnglishMap[match] || match)
}

// Function to format numbers without trailing decimals for whole numbers
const formatNumber = (value: number, decimals: number = 1): string => {
  const isWholeNumber = value === Math.round(value)

  if (isWholeNumber) {
    // Whole number - no decimals (e.g., "14" instead of "14.0")
    return value.toFixed(0)
  } else {
    // Decimal value - show exactly 1 decimal place (e.g., "15.8")
    return value.toFixed(decimals)
  }
}

// Function to format drug rule with Colistin full numbers
const formatDrugRule = (drug: typeof DRUGS[0]): string => {
  if (drug.unit === 'IU' && (drug.id === 5 || drug.id === 6)) {
    // Colistin: Display with ",000" suffix (e.g., "150,000 IU/kg")
    const roundedDose = Math.round(drug.dosePerKg)
    return `${roundedDose.toLocaleString('en-US')},000 IU/kg/dose`
  } else {
    // Other drugs: Normal display
    return `${drug.dosePerKg} ${drug.unit}/kg${drug.timeMultiplier > 1 ? `/${drug.timeMultiplier === 1440 ? 'min' : 'hr'}` : ''}/dose`
  }
}

interface DrugResult {
  drug: typeof DRUGS[0]
  totalDose: number
  displayDose: number
  displayUnit: string
  volumeToDraw: number
  dilutionVolume: number | null
  method: string
}

export default function Home() {
  // Patient info state
  const [babyName, setBabyName] = useState('')
  const [babyWeight, setBabyWeight] = useState('')
  const [error, setError] = useState('')

  // Screen navigation state
  const [currentScreen, setCurrentScreen] = useState<'greeting' | 'drugSelection' | 'results'>('greeting')

  // Drug selection state
  const [selectedDrugs, setSelectedDrugs] = useState<number[]>([])

  // Store patient info
  const [patientInfo, setPatientInfo] = useState<{ name: string; weight: number } | null>(null)

  // Store calculation results
  const [calculationResults, setCalculationResults] = useState<DrugResult[]>([])

  const handleSelectTreatment = () => {
    // Normalize Arabic numerals before validation and parsing
    const normalizedWeight = normalizeArabicNumerals(babyWeight)

    // Validation: Weight field is required and must be a valid number
    if (!normalizedWeight || normalizedWeight.trim() === '') {
      setError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† Ø§Ù„Ø·ÙÙ„')
      return
    }

    // Try to parse as a number (works with both English and Arabic numerals)
    const weightAsNumber = parseFloat(normalizedWeight)
    if (isNaN(weightAsNumber) || weightAsNumber <= 0) {
      setError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ØµØ­ÙŠØ­')
      return
    }

    // Clear any previous error
    setError('')

    // Store patient info
    setPatientInfo({
      name: babyName.trim(),
      weight: weightAsNumber
    })

    // Log the data to console
    console.log('NICU Dose Calculator - Patient Info:', {
      babyName: babyName.trim(),
      babyWeight: weightAsNumber
    })

    // Navigate to drug selection screen
    setCurrentScreen('drugSelection')
  }

  const handleDrugToggle = (drugId: number) => {
    setSelectedDrugs((prev) =>
      prev.includes(drugId)
        ? prev.filter((id) => id !== drugId)
        : [...prev, drugId]
    )
  }

  const handleCalculateDoses = () => {
    if (selectedDrugs.length === 0 || !patientInfo) return

    const results: DrugResult[] = []

    selectedDrugs.forEach(drugId => {
      const drug = DRUGS.find(d => d.id === drugId)
      if (!drug) return

      // Calculate total dose: Weight * Dose per kg * Time Multiplier (if applicable)
      let totalDose = patientInfo.weight * drug.dosePerKg * drug.timeMultiplier

      // Handle Colistin - remove "k" and add ",000" suffix
      let displayDose = totalDose
      let displayUnit = drug.unit

      if (drug.unit === 'IU') {
        // Colistin: Convert to full integer IU and add ",000" suffix
        displayDose = Math.round(totalDose * 1000) + ",000"
        displayUnit = 'IU'
      } else if (drug.unit === 'mcg' && totalDose > 1000) {
        // Convert mcg to mg if dose is above 1000 mcg
        displayDose = totalDose / 1000
        displayUnit = 'mg'
      }

      // Calculate volume to draw (**): Weight * Factor
      // Round to 1 decimal place
      const volumeToDraw = Math.round((patientInfo.weight * drug.factor) * 10) / 10

      // Calculate dilution (##): If method contains ##, it equals (20 - Volume to Draw)
      const methodTemplate = ADMINISTRATION_METHODS[drug.methodIndex]
      const hasDilution = methodTemplate.includes('##')
      const dilutionVolume = hasDilution ? 20 - volumeToDraw : null

      // Replace placeholders with formatted values (1 decimal place)
      let method = methodTemplate.replace(/\*\*/g, formatNumber(volumeToDraw, 1))
      if (hasDilution && dilutionVolume !== null) {
        method = method.replace(/##/g, formatNumber(dilutionVolume, 1))
      }

      results.push({
        drug,
        totalDose,
        displayDose,
        displayUnit,
        volumeToDraw,
        dilutionVolume,
        method
      })
    })

    setCalculationResults(results)

    // Navigate to results screen
    setCurrentScreen('results')
  }

  const handleBackToDrugSelection = () => {
    setCurrentScreen('drugSelection')
  }

  const handleBackToGreeting = () => {
    setCurrentScreen('greeting')
    setSelectedDrugs([])
    setCalculationResults([])
    setPatientInfo(null)
  }

  const handleStartOver = () => {
    setCurrentScreen('greeting')
    setBabyName('')
    setBabyWeight('')
    setSelectedDrugs([])
    setCalculationResults([])
    setPatientInfo(null)
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-br from-sky-50 via-cyan-50 to-teal-50" dir="rtl">
      {/* Header Section */}
      <header className="bg-gradient-to-l from-sky-500 to-teal-500 text-white shadow-lg">
        <div className="container mx-auto px-4 py-6">
          <div className="flex items-center justify-between">
            <div className="flex-1">
              {currentScreen !== 'greeting' && (
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={currentScreen === 'results' ? handleBackToDrugSelection : handleBackToGreeting}
                  className="text-white hover:bg-white/20"
                >
                  <ArrowLeft className="h-6 w-6" />
                </Button>
              )}
            </div>
            <div className="text-center flex-1">
              <h1 className="text-3xl md:text-4xl font-bold">
                Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹
              </h1>
              <p className="text-sky-100 text-sm md:text-base">
                Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø±Ø¹Ø§ÙŠØ© Ø­Ø¯ÙŠØ«ÙŠ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©
              </p>
            </div>
            <div className="flex-1 flex justify-end">
              {(currentScreen === 'drugSelection' || currentScreen === 'results') && patientInfo && (
                <div className="bg-white/20 rounded-lg px-3 py-2 flex items-center gap-2">
                  <Baby className="h-5 w-5" />
                  <div className="text-sm">
                    <div className="font-semibold">{patientInfo.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</div>
                    <div className="text-sky-100">{patientInfo.weight} ÙƒØ¬Ù…</div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 px-4 py-8">
        {/* Greeting Screen */}
        <div
          className={`transition-all duration-500 ease-in-out ${
            currentScreen === 'greeting'
              ? 'opacity-100 translate-y-0'
              : 'opacity-0 -translate-y-4 absolute inset-0 pointer-events-none'
          }`}
        >
          <div className="flex items-center justify-center h-full">
            <div className="w-full max-w-md">
              <Card className="shadow-2xl border-sky-200">
                <CardHeader className="bg-gradient-to-l from-sky-50 to-teal-50 border-b border-sky-200">
                  <CardTitle className="text-2xl text-sky-800 text-center">
                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                  </CardTitle>
                  <CardDescription className="text-center text-sky-700">
                    Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
                  </CardDescription>
                </CardHeader>
                <CardContent className="pt-6 space-y-6">
                  {/* Baby Name Input */}
                  <div className="space-y-2">
                    <Label htmlFor="babyName" className="text-sky-800 text-base font-semibold">
                      Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„
                    </Label>
                    <Input
                      id="babyName"
                      type="text"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„"
                      value={babyName}
                      onChange={(e) => setBabyName(e.target.value)}
                      className="text-lg border-sky-300 focus:border-sky-500 focus:ring-sky-500 text-right"
                      dir="rtl"
                    />
                  </div>

                  {/* Baby Weight Input */}
                  <div className="space-y-2">
                    <Label htmlFor="babyWeight" className="text-sky-800 text-base font-semibold">
                      ÙˆØ²Ù† Ø§Ù„Ø·ÙÙ„ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…
                    </Label>
                    <Input
                      id="babyWeight"
                      type="text"
                      step="0.01"
                      min="0"
                      placeholder="Ù…Ø«Ø§Ù„: 1.25 Ø£Ùˆ Ù¢.Ù¥"
                      value={babyWeight}
                      onChange={(e) => {
                        // Convert Arabic numerals to English numerals
                        const normalizedValue = normalizeArabicNumerals(e.target.value)
                        setBabyWeight(normalizedValue)
                        // Clear error if user starts typing
                        if (error && normalizedValue.trim() !== '') {
                          setError('')
                        }
                      }}
                      className="text-lg border-sky-300 focus:border-sky-500 focus:ring-sky-500 text-right"
                      dir="rtl"
                    />
                    <p className="text-sm text-sky-600">
                      ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù… (ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
                    </p>
                  </div>

                  {/* Error Message */}
                  {error && (
                    <div className="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg text-center">
                      {error}
                    </div>
                  )}

                  {/* Action Button */}
                  <Button
                    onClick={handleSelectTreatment}
                    className="w-full bg-gradient-to-l from-sky-500 to-teal-500 hover:from-sky-600 hover:to-teal-600 text-white text-lg font-bold py-6 shadow-lg transition-all duration-200 hover:shadow-xl"
                  >
                    Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù„Ø§Ø¬
                  </Button>

                  {/* Info Note */}
                  <div className="bg-sky-50 border border-sky-200 rounded-lg p-4">
                    <p className="text-sm text-sky-700 text-center">
                      ğŸ’¡ ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰
                    </p>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        </div>

        {/* Drug Selection Screen */}
        <div
          className={`transition-all duration-500 ease-in-out ${
            currentScreen === 'drugSelection'
              ? 'opacity-100 translate-y-0'
              : 'opacity-0 -translate-y-4 absolute inset-0 pointer-events-none'
          }`}
        >
          <div className="container mx-auto max-w-4xl">
            {/* Patient Info Card */}
            <Card className="mb-6 bg-gradient-to-l from-sky-100 to-teal-100 border-sky-300">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="bg-gradient-to-l from-sky-500 to-teal-500 rounded-full p-3">
                      <Baby className="h-8 w-8" />
                    </div>
                    <div>
                      <h2 className="text-xl font-bold text-sky-800 mb-1">
                        {patientInfo?.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}
                      </h2>
                      <p className="text-sky-700">
                        Ø§Ù„ÙˆØ²Ù†: <span className="font-bold">{patientInfo?.weight}</span> ÙƒØ¬Ù…
                      </p>
                    </div>
                  </div>
                  <div className="bg-white/50 rounded-full px-3 py-2 flex items-center gap-2">
                    <Activity className="h-5 w-5 text-sky-700" />
                    <span className="text-sm text-sky-700">
                      {selectedDrugs.length} Ø¯ÙˆØ§Ø¡ Ù…Ø­Ø¯Ø¯
                    </span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Section Title */}
            <div className="mb-6">
              <h2 className="text-2xl font-bold text-sky-800 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h2>
              <p className="text-sky-700">
                Ø­Ø¯Ø¯ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
              </p>
            </div>

            {/* Drug Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-24">
              {DRUGS.map((drug) => {
                const isSelected = selectedDrugs.includes(drug.id)
                return (
                  <button
                    key={drug.id}
                    onClick={() => handleDrugToggle(drug.id)}
                    className={`
                      relative p-6 rounded-xl border-2 transition-all duration-300
                      hover:shadow-lg hover:-translate-y-1
                      ${isSelected
                        ? 'bg-gradient-to-l from-sky-500 to-blue-600 border-blue-600 text-white shadow-xl'
                        : 'bg-white border-sky-200 hover:border-sky-400 text-sky-800'
                      }
                    `}
                  >
                    {/* Checkmark Icon */}
                    {isSelected && (
                      <div className="absolute top-3 left-3 bg-white/20 rounded-full p-1">
                        <Check className="h-4 w-4 text-white" />
                      </div>
                    )}

                    {/* Drug Info - LTR for English */}
                    <div className="text-left" dir="ltr">
                      <h3 className="text-xl font-bold mb-2">
                        {drug.name}
                      </h3>
                      <p className={`text-sm font-semibold ${isSelected ? 'text-white/90' : 'text-sky-600'}`}>
                        {formatDrugRule(drug)}
                      </p>
                    </div>
                  </button>
                )
              })}
            </div>
          </div>
        </div>

        {/* Results Screen */}
        <div
          className={`transition-all duration-500 ease-in-out ${
            currentScreen === 'results'
              ? 'opacity-100 translate-y-0'
              : 'opacity-0 -translate-y-4 absolute inset-0 pointer-events-none'
          }`}
        >
          <div className="container mx-auto max-w-5xl">
            {/* Summary Card */}
            <Card className="mb-6 bg-gradient-to-l from-emerald-500 to-teal-600 border-emerald-600">
              <CardContent className="p-6 text-white">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="bg-white/20 rounded-full p-3">
                      <Calculator className="h-8 w-8 text-emerald-600" />
                    </div>
                    <div>
                      <h2 className="text-2xl font-bold mb-1">
                        Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨
                      </h2>
                      <p className="text-emerald-100">
                        {patientInfo?.name} - {patientInfo?.weight} ÙƒØ¬Ù… - {calculationResults.length} Ø¯ÙˆØ§Ø¡
                      </p>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-2 w-full max-w-xs">
                    <Button
                      onClick={handleStartOver}
                      variant="outline"
                      className="w-full bg-white/20 border-white text-white font-bold hover:bg-white/30 hover:text-white px-4 py-3"
                    >
                      <FileText className="h-8 w-8 mr-2" />
                      Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯
                    </Button>
                    <a
                      href="https://t.me/NICU_BTHbot"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-flex items-center justify-center gap-2 w-full px-4 py-3 bg-white/20 border border-white text-white font-bold hover:bg-white/30 hover:text-white rounded-lg shadow transition-all duration-200 hover:shadow-lg"
                    >
                      <MessageCircle className="h-8 w-8 mr-2" />
                      Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ø¯Ù„Ø©
                    </a>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Results Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-24">
              {calculationResults.map((result, index) => (
                <Card key={result.drug.id} className="shadow-lg border-emerald-200">
                  <CardHeader className="bg-gradient-to-l from-emerald-50 to-teal-50 border-b border-emerald-200">
                    <div className="flex items-center gap-3" dir="ltr">
                      {/* Elegant number badge */}
                      <div className="bg-gradient-to-l from-emerald-500 to-teal-600 text-white text-xl font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-md">
                        {index + 1}
                      </div>
                      {/* Drug Name - Most prominent element */}
                      <div className="flex-1 text-left">
                        <CardTitle className="text-3xl text-emerald-800 font-black mb-1">
                          {result.drug.name}
                        </CardTitle>
                        <CardDescription className="text-emerald-700 text-base">
                          {formatDrugRule(result.drug)}
                        </CardDescription>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent className="pt-6 space-y-4">
                    {/* Total Dose */}
                    <div className="bg-gradient-to-l from-emerald-100 to-teal-100 rounded-lg p-4">
                      <p className="text-sm text-emerald-700 mb-1">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                      <p className="text-3xl font-bold text-emerald-900">
                        {typeof result.displayDose === 'string' 
                          ? result.displayDose 
                          : formatNumber(result.displayDose, 1)} {result.displayUnit}
                      </p>
                    </div>

                    {/* Administration Method - RTL for Arabic */}
                    <div className="bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4" dir="rtl">
                      <p className="text-sm text-emerald-700 mb-2 font-semibold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¹Ø·Ø§Ø¡</p>
                      <p className="text-base text-sky-800 leading-relaxed">
                        {result.method}
                      </p>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>

            {/* Mandatory Safety Disclaimer */}
            <div className="mt-6 mb-8 bg-amber-50 border-2 border-amber-300 rounded-lg p-4">
              <div className="flex items-start gap-3" dir="rtl">
                <AlertTriangle className="h-6 w-6 text-amber-600 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-amber-900 font-bold text-lg italic mb-1">
                    Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ§ÙƒØ¯ Ø¬ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¬Ø±Ø¹ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø§Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ø¬
                  </p>
                  <p className="text-amber-700 text-sm">
                    âš ï¸ Ø§Ø­Ø±Øµ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¯ÙˆØ§Ø¡
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Fixed Calculate Button (Only visible on Drug Selection Screen) */}
        {currentScreen === 'drugSelection' && (
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-sky-200 p-4 shadow-lg">
            <div className="container mx-auto max-w-4xl">
              <Button
                onClick={handleCalculateDoses}
                disabled={selectedDrugs.length === 0}
                className="w-full py-6 text-lg font-bold shadow-lg transition-all duration-300 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                >
                Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹
                {selectedDrugs.length > 0 && (
                  <span className="mr-2 bg-white/20 px-3 py-1 rounded-full">
                    {selectedDrugs.length}
                  </span>
                )}
              </Button>
            </div>
          </div>
        )}

        {/* Footer (Only visible on Greeting Screen) */}
        {currentScreen === 'greeting' && (
          <footer className="bg-white border-t border-sky-200 py-4 mt-auto">
            <div className="container mx-auto px-4 text-center">
              <p className="text-sky-700 text-sm">
                Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø±Ø¹Ø§ÙŠØ© Ø­Ø¯ÙŠØ«ÙŠ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© - NICU Dose Calculator
              </p>
              <p className="text-sky-500 text-xs mt-1">
                ØªÙ… ØªØµÙ…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· - ÙŠØ±Ø¬Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
              </p>
            </div>
          </footer>
        )}
      </main>
    </div>
  )
}
